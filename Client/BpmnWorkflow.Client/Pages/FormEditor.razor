@page "/form-editor"
@page "/form-editor/{FormId:guid}"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.SignalR.Client
@using BpmnWorkflow.Client.Models
@using BpmnWorkflow.Client.Services
@using Blazored.LocalStorage
@attribute [Authorize]
@inject IFormService FormService
@inject IJSRuntime JsRuntime
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject NavigationManager NavigationManager
@inject ILocalStorageService LocalStorage
@inject ICommentService CommentService
@inject AuthenticationStateProvider AuthStateProvider
@inject Microsoft.Extensions.Configuration.IConfiguration Configuration
@implements IAsyncDisposable

<PageTitle>Form Designer | @_formRequest.Name</PageTitle>

<RadzenStack Gap="1rem">
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
        <RadzenButton Icon="arrow_back" ButtonStyle="ButtonStyle.Light" Click="@GoBack" title="Back to list" />
        <RadzenText TextStyle="TextStyle.H3" Style="margin-bottom: 0;">
            @(FormId.HasValue ? "Edit Form" : "New Form")
        </RadzenText>
        @if (FormId.HasValue && _activeUsers.Any())
        {
            <RadzenBadge BadgeStyle="BadgeStyle.Success" IsPill="true" Text="@($"{_activeUsers.Count} Online: {string.Join(", ", _activeUsers)}")" Style="margin-left: 1rem;" />
        }
    </RadzenStack>

    <RadzenCard>
        <RadzenTextBox @bind-Value="_formRequest.Name" Placeholder="Form name" Style="width:100%;" />
    </RadzenCard>

    <RadzenCard Style="height:750px; overflow:hidden; padding: 0;">
        <RadzenStack Orientation="Orientation.Horizontal" Gap="0" Style="height:100%;"> 
            <!-- Canvas Column -->
            <RadzenStack Gap="0" Style="flex: 1; height:100%; border-right: 1px solid #eee;">
                <!-- Toolbar -->
                <div style="padding: 0.5rem; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                    <RadzenText TextStyle="TextStyle.Caption" Style="margin-right:0.5rem;">Zoom:</RadzenText>
                    <RadzenSlider @bind-Value="@_zoomLevel" TValue="decimal" Min="0.5m" Max="2.0m" Step="0.1m" Change="@OnZoomChange" Style="width: 120px;" />
                    <RadzenText TextStyle="TextStyle.Caption">@(_zoomLevel * 100)%</RadzenText>

                    <div class="toolbar-divider"></div>

                    <RadzenButton Icon="undo" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Light" Click="@Undo" title="Undo" />
                    <RadzenButton Icon="redo" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Light" Click="@Redo" title="Redo" />

                    <div class="toolbar-divider"></div>

                    <RadzenButton Icon="visibility" Text="Preview" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Info" Click="@ShowPreview" />
                    <RadzenButton Icon="download" Text="JSON" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Secondary" Click="@DownloadJson" />
                    <RadzenButton Icon="fullscreen" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Light" Click="@ToggleFullScreen" title="Fullscreen" />
                    
                    <div style="margin-left: auto;">
                        <RadzenButton Text="Save" Icon="save" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" Click="@SaveForm" IsLoading="@_isSaving" />
                    </div>
                </div>

                <!-- Canvas -->
                <div style="flex: 1; position: relative; overflow: auto; background: #fff;" id="form-editor-root">
                    <div id="form-editor-container" style="width: 100%; height: 100%;"></div>
                </div>
            </RadzenStack>

            <!-- Properties/Right Panel -->
            <div style="width: 350px; height: 100%; background: #fdfdfd; display: flex; flex-direction: column;">
                <RadzenTabs Style="height: 100%; display: flex; flex-direction: column;">
                    <Tabs>
                        <RadzenTabsItem Text="Settings" Icon="settings">
                            <RadzenStack Gap="1rem" Style="padding: 1rem;">
                                <RadzenFormField Text="Description" Style="width: 100%;">
                                    <RadzenTextArea @bind-Value="_formRequest.Description" Rows="3" />
                                </RadzenFormField>
                                <RadzenAlert Severity="Severity.Info" AllowClose="false" Size="AlertSize.Small">
                                    Use the palette on the left of the canvas to add fields.
                                </RadzenAlert>
                            </RadzenStack>
                        </RadzenTabsItem>

                        <RadzenTabsItem Text="Comments" Icon="chat">
                             <div style="display:flex; flex-direction:column; height: 600px;">
                                <div style="flex:1; overflow-y:auto; padding: 1rem;">
                                    @if (_isCommentsLoading)
                                    {
                                        <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                                    }
                                    else if (!_comments.Any())
                                    {
                                        <RadzenText TextStyle="TextStyle.Caption" Style="text-align:center; display:block; margin:2rem 0; color:#aaa;">No comments yet.</RadzenText>
                                    }
                                    else
                                    {
                                        <RadzenStack Gap="1rem">
                                            @foreach (var comment in _comments)
                                            {
                                                <div class="comment-bubble">
                                                    <div style="display:flex; justify-content:space-between; margin-bottom: 4px;">
                                                        <span style="font-weight:bold; font-size: 0.8rem;">@comment.UserName</span>
                                                        <span style="font-size:0.7rem; color:#888;">@comment.CreatedAt.ToLocalTime().ToString("g")</span>
                                                    </div>
                                                    <div style="font-size: 0.9rem;">@comment.Text</div>
                                                </div>
                                            }
                                        </RadzenStack>
                                    }
                                </div>
                                <div style="padding: 1rem; border-top: 1px solid #eee;">
                                    <RadzenStack Gap="0.5rem">
                                        <RadzenTextArea @bind-Value="_newCommentText" Placeholder="Add a comment..." Style="width:100%; height:80px;" MaxLength="500" />
                                        <RadzenButton Text="Post" Size="ButtonSize.Small" Click="@PostComment" Disabled="@(string.IsNullOrWhiteSpace(_newCommentText))" />
                                    </RadzenStack>
                                </div>
                            </div>
                        </RadzenTabsItem>

                        <RadzenTabsItem Text="History" Icon="history">
                            <div style="padding: 1rem; height: 600px; overflow-y: auto;">
                                @if (_isVersionsLoading)
                                {
                                    <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                                }
                                else
                                {
                                    <RadzenStack Gap="0.5rem">
                                        @foreach (var version in _versions)
                                        {
                                            <RadzenCard Style="padding: 0.75rem; cursor: pointer;" @onclick="() => RestoreVersion(version)">
                                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                                    <RadzenText TextStyle="TextStyle.Subtitle2" Style="margin:0;">v@version.VersionNumber</RadzenText>
                                                    <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@version.CreatedAt.ToLocalTime().ToString("MMM dd, HH:mm")" />
                                                </div>
                                                <RadzenText TextStyle="TextStyle.Caption" Style="margin-top:0.25rem;">@version.Comment</RadzenText>
                                            </RadzenCard>
                                        }
                                    </RadzenStack>
                                }
                            </div>
                        </RadzenTabsItem>
                    </Tabs>
                </RadzenTabs>
            </div>
        </RadzenStack>
    </RadzenCard>
</RadzenStack>

<style>
    .toolbar-divider {
        width: 1px;
        height: 24px;
        background: #eee;
        margin: 0 0.5rem;
    }

    .comment-bubble {
        background: #f0f7ff;
        padding: 0.75rem;
        border-radius: 12px 12px 12px 0;
        border: 1px solid #d0e7ff;
    }

    /* Zoom fix for container */
    #form-editor-container {
        transition: transform 0.2s;
    }

    .rz-tabview-panels {
        flex: 1;
        overflow: hidden;
    }
</style>

@code {
    [Parameter] public Guid? FormId { get; set; }

    private UpsertFormRequest _formRequest = new() { Name = "Untitled Form", SchemaJson = "{\"components\": [], \"type\": \"default\"}" };
    private bool _isSaving;
    private bool _isInitialized;
    private bool _isFullScreen;
    private decimal _zoomLevel = 1.0m;

    private IEnumerable<CommentDto> _comments = new List<CommentDto>();
    private IEnumerable<FormVersionDto> _versions = new List<FormVersionDto>();
    private string _newCommentText = string.Empty;
    private bool _isCommentsLoading;
    private bool _isVersionsLoading;

    private HubConnection? _hubConnection;
    private List<string> _activeUsers = new();
    private Guid? _currentUserId;
    private string _currentUserName = "Unknown";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            _currentUserId = Guid.Parse(user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? Guid.Empty.ToString());
            _currentUserName = user.Identity.Name ?? "User";
        }

        if (FormId.HasValue)
        {
            var form = await FormService.GetByIdAsync(FormId.Value);
            if (form != null)
            {
                _formRequest.Name = form.Name;
                _formRequest.Description = form.Description;
                _formRequest.SchemaJson = form.SchemaJson;
            }
            
            await LoadComments();
            await LoadVersions();
            await SetupSignalR();
        }
    }

    private async Task SetupSignalR()
    {
        if (!FormId.HasValue) return;

        var baseUrl = Configuration["ApiBaseUrl"] ?? NavigationManager.BaseUri;
        if (baseUrl.EndsWith("/")) baseUrl = baseUrl.TrimEnd('/');

        _hubConnection = new HubConnectionBuilder()
            .WithUrl($"{baseUrl}/hubs/form", options => {
                options.AccessTokenProvider = async () => await LocalStorage.GetItemAsStringAsync("authToken");
            })
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<List<string>>("UpdateUserList", users =>
        {
            _activeUsers = users;
            StateHasChanged();
        });

        _hubConnection.On<string>("ReceiveFormUpdate", async schema => {
            // Option to notify user or auto-apply. For now, just a notification.
            NotificationService.Notify(NotificationSeverity.Info, "Update", "A collaborator has updated the form.");
        });

        await _hubConnection.StartAsync();
        await _hubConnection.SendAsync("JoinForm", FormId.Value.ToString(), _currentUserName);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_isInitialized)
        {
            await Task.Delay(500); // Wait for container to be ready
            await JsRuntime.InvokeVoidAsync("FormBuilder.initialize", "form-editor-container", _formRequest.SchemaJson);
            _isInitialized = true;
        }
    }

    private async Task SaveForm()
    {
        _isSaving = true;
        try
        {
            var schema = await JsRuntime.InvokeAsync<string>("FormBuilder.getSchema");
            _formRequest.SchemaJson = schema;

            if (FormId.HasValue)
            {
                await FormService.UpdateAsync(FormId.Value, _formRequest, "Updated from designer");
                NotificationService.Notify(NotificationSeverity.Success, "Saved", "Form saved successfully.");
                if (_hubConnection != null)
                {
                    await _hubConnection.SendAsync("SendFormUpdate", FormId.Value.ToString(), schema);
                }
            }
            else
            {
                var result = await FormService.CreateAsync(_formRequest);
                if (result != null)
                {
                    NotificationService.Notify(NotificationSeverity.Success, "Created", "New form created.");
                    NavigationManager.NavigateTo($"/form-editor/{result.Id}");
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task LoadComments()
    {
        if (!FormId.HasValue) return;
        _isCommentsLoading = true;
        _comments = await CommentService.GetFormCommentsAsync(FormId.Value);
        _isCommentsLoading = false;
    }

    private async Task PostComment()
    {
        if (!FormId.HasValue || string.IsNullOrWhiteSpace(_newCommentText)) return;
        
        await CommentService.AddFormCommentAsync(FormId.Value, _newCommentText);
        _newCommentText = string.Empty;
        await LoadComments();
    }

    private async Task LoadVersions()
    {
        if (!FormId.HasValue) return;
        _isVersionsLoading = true;
        _versions = await FormService.GetVersionsAsync(FormId.Value);
        _isVersionsLoading = false;
    }

    private async Task RestoreVersion(FormVersionDto version)
    {
        var confirm = await DialogService.Confirm("Are you sure you want to restore this version? Unsaved changes will be lost.", "Restore Version");
        if (confirm == true)
        {
            await JsRuntime.InvokeVoidAsync("FormBuilder.initialize", "form-editor-container", version.SchemaJson);
            _formRequest.SchemaJson = version.SchemaJson;
            NotificationService.Notify(NotificationSeverity.Info, "Restored", $"Version {version.VersionNumber} restored.");
        }
    }

    private async Task ShowPreview()
    {
        var schema = await JsRuntime.InvokeAsync<string>("FormBuilder.getSchema");
        
        await DialogService.OpenAsync("Form Preview", ds =>
            @<RadzenStack Gap="1rem" Style="height: 600px; width: 800px; padding: 1rem;">
                <RadzenText TextStyle="TextStyle.Subtitle2" Style="color: #888;">Live preview of your form:</RadzenText>
                <div style="flex-grow: 1; overflow: auto; border: 1px solid #eee; border-radius: 8px; padding: 1.5rem; background: white;">
                    <div id="form-preview-container"></div>
                </div>
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End">
                    <RadzenButton Text="Close" ButtonStyle="ButtonStyle.Light" Click="() => ds.Close()" />
                </RadzenStack>
            </RadzenStack>, new DialogOptions { Width = "850px", Height = "750px" });
            
        await Task.Delay(300);
        await JsRuntime.InvokeVoidAsync("FormBuilder.initializeViewer", "form-preview-container", schema);
    }

    private async Task DownloadJson()
    {
        var schema = await JsRuntime.InvokeAsync<string>("FormBuilder.getSchema");
        await JsRuntime.InvokeVoidAsync("FormBuilder.downloadSchema", $"{_formRequest.Name.Replace(" ", "_")}.json", schema);
    }

    private async Task Undo() => await JsRuntime.InvokeVoidAsync("FormBuilder.undo");
    private async Task Redo() => await JsRuntime.InvokeVoidAsync("FormBuilder.redo");
    
    private async Task OnZoomChange(decimal value)
    {
        await JsRuntime.InvokeVoidAsync("FormBuilder.zoom", value.ToString().Replace(",", "."));
    }

    private async Task ToggleFullScreen()
    {
        _isFullScreen = !_isFullScreen;
        await JsRuntime.InvokeVoidAsync("FormBuilder.toggleFullScreen", "form-editor-root");
    }

    private void GoBack() => NavigationManager.NavigateTo("/forms");

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection != null)
        {
            if (FormId.HasValue)
            {
                await _hubConnection.SendAsync("LeaveForm", FormId.Value.ToString());
            }
            await _hubConnection.DisposeAsync();
        }
        try { await JsRuntime.InvokeVoidAsync("FormBuilder.destroy"); } catch { }
    }
}
