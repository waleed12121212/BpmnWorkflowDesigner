@page "/camunda-modeler"
@using Microsoft.AspNetCore.SignalR.Client
@using Blazored.LocalStorage
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using BpmnWorkflow.Client.Components.Camunda
@using BpmnWorkflow.Client.Models
@implements IAsyncDisposable
@inject IJSRuntime JSRuntime
@inject IWorkflowService WorkflowService
@inject CamundaClientService CamundaService
@inject Radzen.DialogService DialogService
@inject Radzen.NotificationService NotificationService
@inject ILocalStorageService LocalStorage
@inject AuthenticationStateProvider AuthStateProvider
@inject ICommentService CommentService
@inject Microsoft.Extensions.Configuration.IConfiguration Configuration

<PageTitle>Camunda Modeler</PageTitle>

<div class="bpmn-editor-layout">
    <div class="header-bar">
        <div class="title-section">
            <i class="bi bi-diagram-3-fill me-2"></i>
            <span>Camunda Modeler</span>
            
            @if (WorkflowId.HasValue && _activeUsers.Any())
            {
                <RadzenBadge BadgeStyle="BadgeStyle.Success" IsPill="true" Text="@($"{_activeUsers.Count} Online: {string.Join(", ", _activeUsers)}")" Style="margin-left: 1rem;" />
            }
        </div>
        <div class="actions">
            @if (WorkflowId.HasValue)
            {
                <button class="btn btn-outline-primary btn-sm me-2 position-relative" @onclick="@(() => _isCollaborationVisible = !_isCollaborationVisible)">
                    <i class="bi bi-chat-dots"></i> Collaboration
                    @if (_comments.Any()) {
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                            @_comments.Count()
                        </span>
                    }
                </button>
            }

            <button class="btn btn-outline-secondary btn-sm me-2" @onclick="OpenFile">
                <i class="bi bi-folder-open"></i> Open
            </button>
            <button class="btn btn-outline-secondary btn-sm me-2" @onclick="CreateNew">
                <i class="bi bi-file-earmark-plus"></i> New
            </button>
            <button class="btn btn-success btn-sm me-2" @onclick="SaveWorkflow">
                <i class="bi bi-save"></i> Save
            </button>
            <button class="btn btn-warning btn-sm me-2 text-white" @onclick="DeployWorkflow">
                <i class="bi bi-cloud-upload"></i> Deploy
            </button>
            <button class="btn btn-primary btn-sm" @onclick="DownloadXml">
                <i class="bi bi-download"></i> Export
            </button>
        </div>
    </div>

    <div class="modeler-container">
        <div id="js-canvas" class="canvas"></div>
        <div id="js-properties-panel" class="properties-panel"></div>
        
        @if (_isCollaborationVisible)
        {
            <div class="collaboration-panel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="m-0 fw-bold">Collaboration</h6>
                    <button class="btn btn-sm btn-light" @onclick="@(() => _isCollaborationVisible = false)"><i class="bi bi-x"></i></button>
                </div>
                
                <div class="comments-list">
                    @if (_isCommentsLoading)
                    {
                        <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Style="height: 4px;" />
                    }
                    else if (!_comments.Any())
                    {
                         <div class="text-muted fst-italic small">No comments yet.</div>
                    }
                    else
                    {
                        foreach (var comment in _comments)
                        {
                            <div class="comment-item">
                                <div class="comment-avatar">
                                    @comment.UserName.ToUpper().FirstOrDefault()
                                </div>
                                <div class="comment-content">
                                    <div class="comment-header">
                                        <span class="fw-bold">@comment.UserName</span>
                                        <span class="text-muted small ms-2">@comment.CreatedAt.ToLocalTime().ToString("MMM dd, HH:mm")</span>
                                    </div>
                                    <div class="comment-text">@comment.Text</div>
                                    @if (comment.UserId == _currentUserId)
                                    {
                                        <div class="text-end mt-1">
                                             <button class="btn btn-link text-danger p-0 small text-decoration-none" style="font-size: 0.75rem;" @onclick="@(() => DeleteComment(comment.Id))">Delete</button>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    }
                </div>
                
                <div class="mt-3">
                     <RadzenTextArea @bind-Value="@_newCommentText" Placeholder="Add a comment..." Style="width: 100%; height: 60px; font-size: 0.9rem;" />
                     <RadzenButton Text="Post" Icon="send" Click="@AddComment" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" Disabled="@(string.IsNullOrWhiteSpace(_newCommentText))" Class="mt-2 w-100" />
                </div>
            </div>
        }
    </div>
</div>

<style>
    /* ... existing styles ... */
    .bpmn-editor-layout {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 4rem);
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        overflow: hidden;
        margin: -1rem;
    }

    .header-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1.5rem;
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
    }

    .title-section {
        font-size: 1.1rem;
        font-weight: 600;
        color: #343a40;
        display: flex;
        align-items: center;
    }

    .modeler-container {
        flex: 1;
        display: flex;
        position: relative;
        overflow: hidden;
    }

    .canvas {
        flex: 1;
        height: 100%;
        background-color: white;
    }

    .properties-panel {
        width: 320px;
        height: 100%;
        border-left: 1px solid #e9ecef;
        background-color: #f8f9fa;
        overflow-y: auto;
    }
    
    .collaboration-panel {
        width: 300px;
        background: white;
        border-left: 1px solid #ddd;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        z-index: 10;
        box-shadow: -2px 0 5px rgba(0,0,0,0.05);
    }
    
    .comments-list {
        flex: 1;
        overflow-y: auto;
        padding-right: 5px;
    }
    
    .comment-item {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1rem;
        background: #fdfdfd;
        padding: 0.75rem;
        border-radius: 8px;
        border: 1px solid #eee;
    }
    
    .comment-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #4facfe;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        flex-shrink: 0;
        font-size: 0.8rem;
    }
    
    .comment-content {
        flex: 1;
        font-size: 0.9rem;
    }
    
    .comment-text {
        color: #333;
        margin-top: 0.25rem;
        line-height: 1.4;
    }

    /* Customize Scrollbars */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
</style>

@code {
    [Parameter]
    [SupplyParameterFromQuery]
    public Guid? WorkflowId { get; set; }

    @inject NavigationManager NavigationManager

    // Collaboration State
    private bool _isCollaborationVisible = false;
    private bool _isCommentsLoading = false;
    private List<string> _activeUsers = new();
    private List<CommentDto> _comments = new();
    private string _newCommentText = "";
    private HubConnection? _hubConnection;
    private Guid? _currentUserId;
    private string _currentUserName = "Unknown";
    private string? _hubUrl;

    protected override async Task OnInitializedAsync()
    {
        // Get User Info
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier);
            var nameClaim = user.FindFirst(ClaimTypes.Name);
            if (userIdClaim != null && Guid.TryParse(userIdClaim.Value, out var userId))
            {
                _currentUserId = userId;
                _currentUserName = nameClaim?.Value ?? "User";
            }
        }

        // Setup SignalR and Load Comments if ID is present
        if (WorkflowId.HasValue)
        {
            await LoadCollaborativeData();
            await InitializeSignalR();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitializeModeler();
        }
    }

    private async Task LoadCollaborativeData()
    {
        if (!WorkflowId.HasValue) return;

        _isCommentsLoading = true;
        try 
        {
            _comments = (await CommentService.GetCommentsAsync(WorkflowId.Value)).OrderByDescending(c => c.CreatedAt).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading comments: {ex.Message}");
        }
        finally 
        {
            _isCommentsLoading = false;
        }
    }

    private async Task InitializeSignalR()
    {
        if (!WorkflowId.HasValue) return;

        var baseUrl = Configuration["ApiBaseUrl"] ?? NavigationManager.BaseUri;
        if (baseUrl.EndsWith("/")) baseUrl = baseUrl.TrimEnd('/');
        _hubUrl = $"{baseUrl}/hubs/workflow";
            
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(_hubUrl, options => {
                options.AccessTokenProvider = async () => await LocalStorage.GetItemAsStringAsync("authToken");
            })
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<List<string>>("UpdateUserList", users =>
        {
            _activeUsers = users;
            StateHasChanged();
        });

        _hubConnection.On<string>("UserJoined", name =>
        {
            NotificationService.Notify(Radzen.NotificationSeverity.Info, "Collab", $"{name} joined.");
        });

        _hubConnection.On<string>("UserLeft", name =>
        {
            NotificationService.Notify(Radzen.NotificationSeverity.Info, "Collab", $"{name} left.");
        });

        _hubConnection.On<CommentDto>("ReceiveComment", comment =>
        {
            if (comment.WorkflowId == WorkflowId.Value)
            {
                _comments.Insert(0, comment);
                StateHasChanged();
            }
        });

        await _hubConnection.StartAsync();
        await _hubConnection.SendAsync("JoinWorkflow", WorkflowId.Value.ToString(), _currentUserName);
    }

    private async Task AddComment()
    {
        if (!WorkflowId.HasValue || string.IsNullOrWhiteSpace(_newCommentText)) return;

        try
        {
            var newComment = await CommentService.AddCommentAsync(WorkflowId.Value, _newCommentText, null);

            if (newComment != null)
            {
                _comments.Insert(0, newComment);
                _newCommentText = "";
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(Radzen.NotificationSeverity.Error, "Error", $"Failed to post comment: {ex.Message}");
        }
    }

    private async Task DeleteComment(Guid id)
    {
        try 
        {
            await CommentService.DeleteCommentAsync(id);
            var c = _comments.FirstOrDefault(x => x.Id == id);
            if (c != null) _comments.Remove(c);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(Radzen.NotificationSeverity.Error, "Error", $"Failed to delete: {ex.Message}");
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            if (WorkflowId.HasValue)
            {
                await _hubConnection.SendAsync("LeaveWorkflow", WorkflowId.Value.ToString());
            }
            await _hubConnection.DisposeAsync();
        }
    }

    private async Task InitializeModeler()
    {
        try 
        {
            // Give the browser a moment to parse the large JS bundle if needed
            int retries = 0;
            while (retries < 10) 
            {
                var isReady = await JSRuntime.InvokeAsync<bool>("eval", "typeof CamundaModeler !== 'undefined' && typeof CamundaModeler.init === 'function'");
                if (isReady) break;
                await Task.Delay(500);
                retries++;
            }

            await JSRuntime.InvokeVoidAsync("CamundaModeler.init", "js-canvas", "js-properties-panel");

            string xmlToLoad = null;

            if (WorkflowId.HasValue)
            {
                try {
                    var wf = await WorkflowService.GetByIdAsync(WorkflowId.Value);
                    if (wf != null && !string.IsNullOrEmpty(wf.BpmnXml)) 
                    {
                        xmlToLoad = wf.BpmnXml;
                        Console.WriteLine($"Loaded workflow {WorkflowId.Value} from database.");
                    }
                } catch (Exception ex) {
                    Console.WriteLine($"Error fetching workflow {WorkflowId}: {ex.Message}");
                }
            }

            if (string.IsNullOrEmpty(xmlToLoad))
            {
                // Create unique diagram
                try {
                    xmlToLoad = await JSRuntime.InvokeAsync<string>("BpmnModeler.getEmptyDiagramXML");
                } catch (Exception ex) {
                    Console.WriteLine($"Error creating unique diagram: {ex.Message}");
                }
            }

            if (!string.IsNullOrEmpty(xmlToLoad))
            {
                await JSRuntime.InvokeVoidAsync("CamundaModeler.importXML", xmlToLoad);
            }

            // Load templates from absolute path
            try {
                await JSRuntime.InvokeVoidAsync("CamundaModeler.loadTemplates", "/templates/all-connectors.json");
            } catch (Exception ex) {
                Console.WriteLine($"Could not load templates: {ex.Message}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing Camunda Modeler: {ex.Message}");
        }
    }

    private async Task OpenFile()
    {
        await JSRuntime.InvokeVoidAsync("CamundaModeler.triggerOpenFile");
    }

    private async Task CreateNew()
    {
        // For new workflows in this view, we might want to just reset the modeler
        // But if we want proper ID handling, maybe redirect to same page without ID?
        // Current logic just re-inits modler.
        _comments.Clear();
        _activeUsers.Clear();
        WorkflowId = null; // Reset ID context
        await InitializeModeler();
    }

    private async Task DownloadXml()
    {
        var xml = await JSRuntime.InvokeAsync<string>("CamundaModeler.getXML");
        if (!string.IsNullOrEmpty(xml))
        {
             await JSRuntime.InvokeVoidAsync("CamundaModeler.downloadFileFromStream", "diagram.bpmn", xml);
        }
    }

    private async Task SaveWorkflow()
    {
        var xml = await JSRuntime.InvokeAsync<string>("CamundaModeler.getXML");
        if (string.IsNullOrEmpty(xml)) return;

        // Fetch existing details if updating
        string defaultName = "";
        string defaultDesc = "";
        if (WorkflowId.HasValue) 
        {
            try 
            {
                var wf = await WorkflowService.GetByIdAsync(WorkflowId.Value);
                if (wf != null) 
                {
                    defaultName = wf.Name;
                    defaultDesc = wf.Description ?? "";
                }
            } 
            catch { /* Ignore if fetch fails, treat as new-ish or just keep defaults */ }
        }

        var result = await DialogService.OpenAsync<SaveWorkflowDialog>("Save Designed Workflow", 
            new Dictionary<string, object> { { "DefaultName", defaultName }, { "DefaultDescription", defaultDesc } }, 
            new Radzen.DialogOptions { Width = "500px" });

        if (result is SaveWorkflowDialog.SaveResult saveResult)
        {
            try 
            {
                var request = new UpsertWorkflowRequest {
                    Name = saveResult.Name,
                    Description = saveResult.Description,
                    BpmnXml = xml,
                    Category = "Camunda"
                };

                if (WorkflowId.HasValue) 
                {
                     await WorkflowService.UpdateAsync(WorkflowId.Value, request);
                     NotificationService.Notify(Radzen.NotificationSeverity.Success, "Updated", "Workflow updated successfully.");
                }
                else
                {
                    var newWf = await WorkflowService.CreateAsync(request);
                    if (newWf != null) 
                    {
                        WorkflowId = newWf.Id; // Set current ID so subsequent saves are updates
                        
                        // Start Collaboration features for the new workflow
                        await LoadCollaborativeData();
                        await InitializeSignalR();
                        
                        NotificationService.Notify(Radzen.NotificationSeverity.Success, "Saved", "Workflow saved successfully.");
                    }
                }
            } catch (Exception ex) {
                NotificationService.Notify(Radzen.NotificationSeverity.Error, "Error", $"Failed to save: {ex.Message}");
            }
        }
    }

    private async Task DeployWorkflow()
    {
        var xml = await JSRuntime.InvokeAsync<string>("CamundaModeler.getXML");
        if (string.IsNullOrEmpty(xml)) return;

        var result = await DialogService.OpenAsync<DeployRawXmlDialog>("Deploy to Camunda", 
            new Dictionary<string, object>(), 
            new Radzen.DialogOptions { Width = "500px" });

        if (result is DeployRawXmlDialog.DeployResult deployResult)
        {
            try {
                var res = await CamundaService.DeployRawXmlAsync(deployResult.Name, xml, deployResult.EnvironmentId);
                NotificationService.Notify(Radzen.NotificationSeverity.Success, "Deployed", 
                    $"Successfully deployed to environment. Deployment ID: {res?.DeploymentId}");
            } catch (Exception ex) {
                NotificationService.Notify(Radzen.NotificationSeverity.Error, "Deployment Failed", ex.Message);
            }
        }
    }
}
