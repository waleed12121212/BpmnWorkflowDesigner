@page "/camunda-modeler"
@inject IJSRuntime JSRuntime
@inject IWorkflowService WorkflowService
@inject CamundaClientService CamundaService
@inject Radzen.DialogService DialogService
@inject Radzen.NotificationService NotificationService
@using BpmnWorkflow.Client.Components.Camunda
@using BpmnWorkflow.Client.Models

<PageTitle>Camunda Modeler</PageTitle>

<div class="bpmn-editor-layout">
    <div class="header-bar">
        <div class="title-section">
            <i class="bi bi-diagram-3-fill me-2"></i>
            <span>Camunda Modeler</span>
        </div>
        <div class="actions">
            <button class="btn btn-outline-secondary btn-sm me-2" @onclick="OpenFile">
                <i class="bi bi-folder-open"></i> Open
            </button>
            <button class="btn btn-outline-secondary btn-sm me-2" @onclick="CreateNew">
                <i class="bi bi-file-earmark-plus"></i> New
            </button>
            <button class="btn btn-success btn-sm me-2" @onclick="SaveWorkflow">
                <i class="bi bi-save"></i> Save
            </button>
            <button class="btn btn-warning btn-sm me-2 text-white" @onclick="DeployWorkflow">
                <i class="bi bi-cloud-upload"></i> Deploy
            </button>
            <button class="btn btn-primary btn-sm" @onclick="DownloadXml">
                <i class="bi bi-download"></i> Export
            </button>
        </div>
    </div>

    <div class="modeler-container">
        <div id="js-canvas" class="canvas"></div>
        <div id="js-properties-panel" class="properties-panel"></div>
    </div>
</div>

<style>
    .bpmn-editor-layout {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 4rem); /* Adjust based on your layout's header height */
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        overflow: hidden;
        margin: -1rem; /* Negative margin to fill available space if inside a padded container */
    }

    .header-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1.5rem;
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
    }

    .title-section {
        font-size: 1.1rem;
        font-weight: 600;
        color: #343a40;
        display: flex;
        align-items: center;
    }

    .modeler-container {
        flex: 1;
        display: flex;
        position: relative;
        overflow: hidden;
    }

    .canvas {
        flex: 1;
        height: 100%;
        background-color: white;
    }

    .properties-panel {
        width: 320px;
        height: 100%;
        border-left: 1px solid #e9ecef;
        background-color: #f8f9fa;
        overflow-y: auto;
    }

    /* Customize Scrollbars */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
</style>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitializeModeler();
        }
    }

    private async Task InitializeModeler()
    {
        try 
        {
            // Give the browser a moment to parse the large JS bundle if needed
            int retries = 0;
            while (retries < 10) 
            {
                var isReady = await JSRuntime.InvokeAsync<bool>("eval", "typeof CamundaModeler !== 'undefined' && typeof CamundaModeler.init === 'function'");
                if (isReady) break;
                await Task.Delay(500);
                retries++;
            }

            await JSRuntime.InvokeVoidAsync("CamundaModeler.init", "js-canvas", "js-properties-panel");

            // Overwrite with unique process ID
            try {
                var uniqueXml = await JSRuntime.InvokeAsync<string>("BpmnModeler.getEmptyDiagramXML");
                await JSRuntime.InvokeVoidAsync("CamundaModeler.importXML", uniqueXml);
            } catch (Exception ex) {
                Console.WriteLine($"Error creating unique diagram: {ex.Message}");
            }

            // Load templates from absolute path
            try {
                await JSRuntime.InvokeVoidAsync("CamundaModeler.loadTemplates", "/templates/all-connectors.json");
            } catch (Exception ex) {
                Console.WriteLine($"Could not load templates: {ex.Message}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing Camunda Modeler: {ex.Message}");
        }
    }

    private async Task OpenFile()
    {
        await JSRuntime.InvokeVoidAsync("CamundaModeler.triggerOpenFile");
    }

    private async Task CreateNew()
    {
        await InitializeModeler();
    }

    private async Task DownloadXml()
    {
        var xml = await JSRuntime.InvokeAsync<string>("CamundaModeler.getXML");
        if (!string.IsNullOrEmpty(xml))
        {
             await JSRuntime.InvokeVoidAsync("CamundaModeler.downloadFileFromStream", "diagram.bpmn", xml);
        }
    }

    private async Task SaveWorkflow()
    {
        var xml = await JSRuntime.InvokeAsync<string>("CamundaModeler.getXML");
        if (string.IsNullOrEmpty(xml)) return;

        var result = await DialogService.OpenAsync<SaveWorkflowDialog>("Save Designed Workflow", 
            new Dictionary<string, object>(), 
            new Radzen.DialogOptions { Width = "500px" });

        if (result is SaveWorkflowDialog.SaveResult saveResult)
        {
            try {
                var request = new UpsertWorkflowRequest {
                    Name = saveResult.Name,
                    Description = saveResult.Description,
                    BpmnXml = xml,
                    Category = "Camunda"
                };
                await WorkflowService.CreateAsync(request);
                NotificationService.Notify(Radzen.NotificationSeverity.Success, "Saved", "Workflow saved successfully to database.");
            } catch (Exception ex) {
                NotificationService.Notify(Radzen.NotificationSeverity.Error, "Error", $"Failed to save: {ex.Message}");
            }
        }
    }

    private async Task DeployWorkflow()
    {
        var xml = await JSRuntime.InvokeAsync<string>("CamundaModeler.getXML");
        if (string.IsNullOrEmpty(xml)) return;

        var result = await DialogService.OpenAsync<DeployRawXmlDialog>("Deploy to Camunda", 
            new Dictionary<string, object>(), 
            new Radzen.DialogOptions { Width = "500px" });

        if (result is DeployRawXmlDialog.DeployResult deployResult)
        {
            try {
                var res = await CamundaService.DeployRawXmlAsync(deployResult.Name, xml, deployResult.EnvironmentId);
                NotificationService.Notify(Radzen.NotificationSeverity.Success, "Deployed", 
                    $"Successfully deployed to environment. Deployment ID: {res?.DeploymentId}");
            } catch (Exception ex) {
                NotificationService.Notify(Radzen.NotificationSeverity.Error, "Deployment Failed", ex.Message);
            }
        }
    }
}
