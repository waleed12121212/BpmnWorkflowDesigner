@page "/workflows"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject Services.IWorkflowService WorkflowService
@inject NavigationManager NavigationManager
@inject IJSRuntime JsRuntime

@inject Radzen.DialogService DialogService
@inject Radzen.NotificationService NotificationService

<PageTitle>Workflows</PageTitle>

<RadzenStack Gap="1rem">
    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
        <RadzenText TextStyle="TextStyle.H3">Workflows</RadzenText>
    </RadzenStack>

    <RadzenCard>
        <RadzenTextBox @bind-Value="_search" Placeholder="Search workflows..."
                       Style="width:100%;" Change="@OnSearchChanged" />
    </RadzenCard>

    <RadzenCard>
        <RadzenDataGrid @ref="_grid" Data="@_workflows" TItem="BpmnWorkflow.Client.Models.WorkflowDto"
                        Count="@_totalCount" LoadData="@LoadData" AllowPaging="true" PageSize="10" IsLoading="@_isLoading">
            <Columns>
                <RadzenDataGridColumn TItem="BpmnWorkflow.Client.Models.WorkflowDto" Property="Name" Title="Name" />
                <RadzenDataGridColumn TItem="BpmnWorkflow.Client.Models.WorkflowDto" Property="OwnerName" Title="Owner" />
                <RadzenDataGridColumn TItem="BpmnWorkflow.Client.Models.WorkflowDto" Property="Version" Title="v" Width="60px" />
                <RadzenDataGridColumn TItem="BpmnWorkflow.Client.Models.WorkflowDto" Title="Preview" Sortable="false" Filterable="false" Width="140px">
                    <Template Context="workflow">
                        <div class="workflow-preview-cell" @onclick="@(() => NavigationManager.NavigateTo($"/workflow-preview/{workflow.Id}"))" style="cursor: pointer; width: 120px; height: 80px; overflow: hidden; position: relative; border: 1px solid #e0e0e0; border-radius: 4px; background: #fff;">
                            @if (!string.IsNullOrEmpty(workflow.SvgPreview))
                            {
                                 <div style="transform: scale(0.3); transform-origin: top left; width: 333%; height: 333%; pointer-events: none;">
                                    @((MarkupString)workflow.SvgPreview)
                                 </div>
                            }
                            else
                            {
                                 <div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; background: #f9f9f9;">
                                    <RadzenIcon Icon="image" Style="color: #ccc; font-size: 2rem;" />
                                 </div>
                            }
                        </div>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="BpmnWorkflow.Client.Models.WorkflowDto" Property="UpdatedAt" Title="Updated" FormatString="{0:d}" />
                <RadzenDataGridColumn TItem="BpmnWorkflow.Client.Models.WorkflowDto" Title="Actions" Sortable="false" Filterable="false" Width="150px">
                    <Template Context="workflow">
                        <RadzenButton Icon="visibility" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small" Class="rz-mr-1"
                                      Click="@(() => NavigationManager.NavigateTo($"/workflow-preview/{workflow.Id}"))" 
                                      title="Preview" />

                        <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small"
                                      Click="@(() => DeleteWorkflow(workflow))" 
                                      title="Delete" />
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    </RadzenCard>
</RadzenStack>

@code {
    private string? _search;
    private bool _isLoading;
    private int _totalCount;
    private IEnumerable<BpmnWorkflow.Client.Models.WorkflowDto> _workflows;
    private RadzenDataGrid<BpmnWorkflow.Client.Models.WorkflowDto> _grid;

    private async Task LoadData(LoadDataArgs args)
    {
        _isLoading = true;
        try
        {
            var page = (args.Skip / args.Top) + 1 ?? 1;
            var pageSize = args.Top ?? 10;
            
            var result = await WorkflowService.GetPagedWorkflowsAsync(page, (int)pageSize, _search);
            _workflows = result.Items;
            _totalCount = result.TotalCount;

            // Trigger preview generation in background
            _ = GenerateMissingPreviews();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Could not load workflows");
            Console.WriteLine($"Load error: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task GenerateMissingPreviews()
    {
        if (_workflows == null) return;

        // Clone list to iterate safely
        var itemsToCheck = _workflows.ToList();

        foreach (var wf in itemsToCheck)
        {
            if (string.IsNullOrEmpty(wf.SvgPreview) && !string.IsNullOrEmpty(wf.BpmnXml))
            {
                try 
                {
                    var svg = await JsRuntime.InvokeAsync<string>("SvgExporter.getSvgFromXml", wf.BpmnXml);
                    if (!string.IsNullOrEmpty(svg))
                    {
                        wf.SvgPreview = svg;
                        StateHasChanged();
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error gen preview for {wf.Id}: {ex.Message}");
                }
                
                await Task.Delay(10);
            }
        }
    }

    private async Task OnSearchChanged(object _)
    {
        // When searching, reset to first page
        await _grid.FirstPage();
    }

    private async Task DeleteWorkflow(BpmnWorkflow.Client.Models.WorkflowDto workflow)
    {
        var confirm = await DialogService.Confirm($"Are you sure you want to delete '{workflow.Name}'?", "Delete Workflow", 
            new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No" });
            
        if (confirm == true)
        {
            await WorkflowService.DeleteAsync(workflow.Id);
            NotificationService.Notify(NotificationSeverity.Success, "Deleted", "Workflow deleted successfully");
            await _grid.Reload();
        }
    }
}


