@page "/"
@page "/dashboard"
@using BpmnWorkflow.Client.Models
@using BpmnWorkflow.Client.Constants
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject Services.IWorkflowService WorkflowService
@inject NavigationManager NavigationManager
@inject Radzen.DialogService DialogService
@inject IJSRuntime JsRuntime

<PageTitle>Dashboard</PageTitle>

<RadzenStack Gap="1.5rem">
    
    <!-- Header Area -->
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
        <RadzenText TextStyle="TextStyle.H3" Style="margin: 0">Dashboard</RadzenText>
        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
            <RadzenButton Icon="palette" Text="Template Gallery" Click="@OpenTemplateGallery" ButtonStyle="ButtonStyle.Secondary" />
            <RadzenButton Icon="add" Text="New Workflow" Click="@CreateNew" ButtonStyle="ButtonStyle.Primary" />
        </RadzenStack>
    </RadzenStack>

    <!-- Stats Cards -->
    <RadzenRow>
        <RadzenColumn Size="12" SizeMD="3">
            <RadzenCard Style="background: rgba(79, 172, 254, 0.1); border-left: 5px solid #4facfe;">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                    <RadzenIcon Icon="list_alt" Style="font-size: 2.5rem; color: #4facfe;" />
                    <RadzenStack Gap="0">
                        <RadzenText TextStyle="TextStyle.Caption" Style="color: #666; margin-bottom: 0;">Total Workflows</RadzenText>
                        <RadzenText TextStyle="TextStyle.H4" Style="margin-bottom: 0; font-weight: bold;">@_stats.Total</RadzenText>
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="3">
            <RadzenCard Style="background: rgba(67, 233, 123, 0.1); border-left: 5px solid #43e97b;">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                    <RadzenIcon Icon="check_circle" Style="font-size: 2.5rem; color: #43e97b;" />
                    <RadzenStack Gap="0">
                        <RadzenText TextStyle="TextStyle.Caption" Style="color: #666; margin-bottom: 0;">Published</RadzenText>
                        <RadzenText TextStyle="TextStyle.H4" Style="margin-bottom: 0; font-weight: bold;">@_stats.Published</RadzenText>
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="3">
            <RadzenCard Style="background: rgba(250, 112, 154, 0.1); border-left: 5px solid #fa709a;">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                    <RadzenIcon Icon="edit_note" Style="font-size: 2.5rem; color: #fa709a;" />
                    <RadzenStack Gap="0">
                        <RadzenText TextStyle="TextStyle.Caption" Style="color: #666; margin-bottom: 0;">Drafts</RadzenText>
                        <RadzenText TextStyle="TextStyle.H4" Style="margin-bottom: 0; font-weight: bold;">@_stats.Drafts</RadzenText>
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="3">
            <RadzenCard Style="background: rgba(254, 225, 64, 0.1); border-left: 5px solid #fee140;">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                    <RadzenIcon Icon="history" Style="font-size: 2.5rem; color: #d4af37;" />
                    <RadzenStack Gap="0">
                        <RadzenText TextStyle="TextStyle.Caption" Style="color: #666; margin-bottom: 0;">Recently Modified</RadzenText>
                        <RadzenText TextStyle="TextStyle.H4" Style="margin-bottom: 0; font-weight: bold;">@(_stats.LatestUpdate?.ToString("dd/MM") ?? "-")</RadzenText>
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <!-- Recent Workflows & Search -->
    <RadzenCard>
        <RadzenStack Gap="1.5rem">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Wrap="FlexWrap.Wrap">
                <RadzenText TextStyle="TextStyle.H5" Style="margin: 0">My Workflows</RadzenText>
                <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
                    <RadzenTextBox Placeholder="Search..." @oninput="@OnSearch" Style="width: 250px;" />
                     <RadzenButton Icon="sort" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Medium" title="Sort Options" />
                </RadzenStack>
            </RadzenStack>

            @if (_isLoading)
            {
                <RadzenProgressBarCircular Mode="ProgressBarMode.Indeterminate" ShowValue="false" />
            }
            else if (!_filteredWorkflows.Any())
            {
                <div style="text-align: center; padding: 4rem;">
                    <RadzenIcon Icon="search_off" Style="font-size: 4rem; color: #ddd;" />
                    <RadzenText TextStyle="TextStyle.H6" Style="color: #aaa; margin-top: 1rem;">No workflows match your search.</RadzenText>
                </div>
            }
            else
            {
                <RadzenDataList WrapItems="true" AllowPaging="true" Data="@_filteredWorkflows" TItem="WorkflowDto" PageSize="6">
                    <Template Context="workflow">
                        <RadzenCard Style="width: 380px; margin: 0.75rem; padding: 0; overflow: hidden; position: relative;" Class="workflow-card">
                            <!-- Thumbnail Area -->
                            <div class="thumbnail-container" @onclick="@(() => NavigationManager.NavigateTo($"/workflow-editor/{workflow.Id}"))">
                                @if (!string.IsNullOrEmpty(workflow.SvgPreview))
                                {
                                    <div class="svg-thumbnail">
                                        @((MarkupString)workflow.SvgPreview)
                                    </div>
                                }
                                else
                                {
                                    <div class="empty-thumbnail">
                                        <RadzenIcon Icon="architecture" Style="font-size: 4rem; color: #eee;" />
                                    </div>
                                }
                                <div class="card-overlay">
                                    <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Medium" 
                                                  Click="@(() => OnEditWorkflow(workflow.Id))" />
                                </div>
                            </div>

                            <RadzenStack Gap="0.5rem" Style="padding: 1rem;">
                                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                    <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; font-size: 1.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1;">
                                        @workflow.Name
                                    </RadzenText>
                                    <RadzenBadge BadgeStyle="@(workflow.IsPublished ? BadgeStyle.Success : BadgeStyle.Warning)" 
                                                 IsPill="true" Text="@(workflow.IsPublished ? "Published" : "Draft")" />
                                </RadzenStack>
                                
                                <RadzenText TextStyle="TextStyle.Caption" Style="color: #888;">
                                    <RadzenIcon Icon="event" Style="font-size: 0.8rem; margin-right: 0.25rem;" />
                                    Modified @GetTimeAgo(workflow.UpdatedAt)
                                </RadzenText>

                                <RadzenText TextStyle="TextStyle.Body2" Style="color: #666; height: 36px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                                    @(string.IsNullOrEmpty(workflow.Description) ? "No description provided." : workflow.Description)
                                </RadzenText>
                                
                                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem" Style="margin-top: 0.5rem;">
                                    <RadzenButton Icon="visibility" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.ExtraSmall" 
                                                  Click="@(() => OnViewWorkflow(workflow.Id))" title="Preview" Text="View" />
                                     <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Text" Size="ButtonSize.ExtraSmall" 
                                                  Click="@(() => OnDeleteWorkflow(workflow.Id))" />
                                </RadzenStack>
                            </RadzenStack>
                        </RadzenCard>
                    </Template>
                </RadzenDataList>
            }
        </RadzenStack>
    </RadzenCard>

</RadzenStack>

<style>
    .workflow-card {
        transition: all 0.3s ease;
        border: 1px solid #eee;
    }
    .workflow-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        border-color: #4facfe;
    }
    .thumbnail-container {
        height: 180px;
        background: #fbfbfb;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        border-bottom: 1px solid #eee;
        cursor: pointer;
    }
    .svg-thumbnail {
        transform: scale(0.35);
        transform-origin: center;
        pointer-events: none;
    }
    .empty-thumbnail {
        opacity: 0.5;
    }
    .card-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s;
    }
    .thumbnail-container:hover .card-overlay {
        opacity: 1;
    }
    .dark .workflow-card {
        background: #2a2a2a;
        border-color: #444;
    }
    .dark .thumbnail-container {
        background: #1e1e1e;
        border-color: #444;
    }
</style>

@code {
    private List<WorkflowDto> _allWorkflows = new();
    private List<WorkflowDto> _filteredWorkflows = new();
    private bool _isLoading = true;
    private StatsModel _stats = new();

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            _allWorkflows = (await WorkflowService.GetWorkflowsAsync()).ToList();
            _filteredWorkflows = _allWorkflows.OrderByDescending(w => w.UpdatedAt).ToList();
            CalculateStats();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void CalculateStats()
    {
        _stats = new StatsModel
        {
            Total = _allWorkflows.Count,
            Published = _allWorkflows.Count(w => w.IsPublished),
            Drafts = _allWorkflows.Count(w => !w.IsPublished),
            LatestUpdate = _allWorkflows.Any() ? _allWorkflows.Max(w => w.UpdatedAt) : null
        };
    }

    private void OnSearch(ChangeEventArgs args)
    {
        var term = args.Value?.ToString()?.ToLower() ?? "";
        if (string.IsNullOrWhiteSpace(term))
        {
            _filteredWorkflows = _allWorkflows.OrderByDescending(w => w.UpdatedAt).ToList();
        }
        else
        {
            _filteredWorkflows = _allWorkflows
                .Where(w => w.Name.ToLower().Contains(term) || (w.Description?.ToLower().Contains(term) ?? false))
                .OrderByDescending(w => w.UpdatedAt)
                .ToList();
        }
    }

    private async Task DeleteWorkflow(Guid id)
    {
        // Simple deletion for dashboard
        if (await WorkflowService.DeleteAsync(id))
        {
            _allWorkflows.RemoveAll(w => w.Id == id);
            _filteredWorkflows.RemoveAll(w => w.Id == id);
            CalculateStats();
        }
    }

    private string GetTimeAgo(DateTime dateTime)
    {
        var span = DateTime.Now - dateTime;
        if (span.TotalDays > 7) return dateTime.ToString("MMM dd");
        if (span.TotalDays >= 1) return $"{(int)span.TotalDays}d ago";
        if (span.TotalHours >= 1) return $"{(int)span.TotalHours}h ago";
        if (span.TotalMinutes >= 1) return $"{(int)span.TotalMinutes}m ago";
        return "Just now";
    }

    private void OnEditWorkflow(Guid id) => NavigationManager.NavigateTo($"/workflow-editor/{id}");
    private void OnViewWorkflow(Guid id) => NavigationManager.NavigateTo($"/workflow-preview/{id}");
    private async Task OnDeleteWorkflow(Guid id) => await DeleteWorkflow(id);

    private async Task OpenTemplateGallery()
    {
        await DialogService.OpenAsync("Template Gallery", ds =>
            @<RadzenStack Gap="1.5rem">
                <RadzenText TextStyle="TextStyle.Body1">Choose a template to start quickly.</RadzenText>
                <RadzenRow>
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenCard Style="height: 100%; display: flex; flex-direction: column;">
                            <RadzenStack Gap="1rem" Style="flex: 1;">
                                <div style="background: #f5f5f5; height: 120px; display: flex; align-items: center; justify-content: center; border-radius: 4px;">
                                    <RadzenIcon Icon="check_circle" Style="font-size: 3rem; color: #4facfe;" />
                                </div>
                                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Simple Approval</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2">A linear process for basic approval tasks between a requestor and a manager.</RadzenText>
                            </RadzenStack>
                            <RadzenButton Text="Use Template" Click="@(() => UseTemplate(BpmnTemplates.SimpleApproval, "Simple Approval Process"))" ButtonStyle="ButtonStyle.Primary" Style="margin-top: 1rem;" />
                        </RadzenCard>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenCard Style="height: 100%; display: flex; flex-direction: column;">
                            <RadzenStack Gap="1rem" Style="flex: 1;">
                                <div style="background: #f5f5f5; height: 120px; display: flex; align-items: center; justify-content: center; border-radius: 4px;">
                                    <RadzenIcon Icon="people" Style="font-size: 3rem; color: #43e97b;" />
                                </div>
                                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Customer Onboarding</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2">Includes decision gateways, user tasks, and multiple end states for onboarding customers.</RadzenText>
                            </RadzenStack>
                            <RadzenButton Text="Use Template" Click="@(() => UseTemplate(BpmnTemplates.CustomerOnboarding, "Customer Onboarding"))" ButtonStyle="ButtonStyle.Primary" Style="margin-top: 1rem;" />
                        </RadzenCard>
                    </RadzenColumn>
                </RadzenRow>
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End">
                    <RadzenButton Text="Close" Click="() => ds.Close()" ButtonStyle="ButtonStyle.Light" />
                </RadzenStack>
            </RadzenStack>, new DialogOptions { Width = "800px" });
    }

    private async Task UseTemplate(string xml, string name)
    {
        await JsRuntime.InvokeVoidAsync("localStorage.setItem", "new_workflow_template", xml);
        await JsRuntime.InvokeVoidAsync("localStorage.setItem", "new_workflow_name", name);
        NavigationManager.NavigateTo("/workflow-editor");
        DialogService.Close();
    }

    private void CreateNew()
    {
        NavigationManager.NavigateTo("/workflow-editor");
    }

    private class StatsModel
    {
        public int Total { get; set; }
        public int Published { get; set; }
        public int Drafts { get; set; }
        public DateTime? LatestUpdate { get; set; }
    }
}
