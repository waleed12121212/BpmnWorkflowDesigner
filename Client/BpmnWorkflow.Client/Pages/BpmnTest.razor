@page "/bpmn-test"
@inject IJSRuntime JSRuntime

<PageTitle>BPMN Test</PageTitle>

<RadzenStack Gap="1rem">
    <RadzenText TextStyle="TextStyle.H3">BPMN Library Test</RadzenText>
    
    <RadzenCard>
        <RadzenButton Text="Check BPMN Library" Click="@CheckBpmnLibrary" ButtonStyle="ButtonStyle.Primary" />
    </RadzenCard>
    
    @if (!string.IsNullOrEmpty(_result))
    {
        <RadzenCard>
            <RadzenText TextStyle="TextStyle.H5">Result:</RadzenText>
            <pre style="background:#f5f5f5; padding:1rem; border-radius:4px; overflow:auto;">@_result</pre>
        </RadzenCard>
    }
    
    <RadzenCard Style="height:600px;">
        <div id="test-container" style="width:100%; height:100%; border:1px solid #ccc;"></div>
    </RadzenCard>
    
    <RadzenButton Text="Initialize Test Modeler" Click="@InitializeTestModeler" ButtonStyle="ButtonStyle.Success" />
</RadzenStack>

@code {
    private string _result = "";

    private async Task CheckBpmnLibrary()
    {
        try
        {
            var result = await JSRuntime.InvokeAsync<string>("eval", @"
                const libs = [];
                if (window.BpmnJS) libs.push('BpmnJS: ' + typeof window.BpmnJS);
                if (window.BpmnModeler) libs.push('BpmnModeler: ' + typeof window.BpmnModeler);
                if (window.Modeler) libs.push('Modeler: ' + typeof window.Modeler);
                if (window.BpmnViewer) libs.push('BpmnViewer: ' + typeof window.BpmnViewer);
                
                const allGlobals = Object.keys(window).filter(k => k.toLowerCase().includes('bpmn'));
                
                return 'Found libraries:\\n' + libs.join('\\n') + 
                       '\\n\\nAll BPMN-related globals:\\n' + allGlobals.join(', ');
            ");
            
            _result = result;
        }
        catch (Exception ex)
        {
            _result = $"Error: {ex.Message}";
        }
    }

    private async Task InitializeTestModeler()
    {
        try
        {
            var result = await JSRuntime.InvokeAsync<string>("eval", @"
                try {
                    const container = document.getElementById('test-container');
                    if (!container) return 'Container not found!';
                    
                    const BpmnConstructor = window.BpmnJS || window.BpmnModeler || window.Modeler;
                    if (!BpmnConstructor) return 'No BPMN constructor found!';
                    
                    const modeler = new BpmnConstructor({
                        container: container,
                        keyboard: { bindTo: document }
                    });
                    
                    const xml = `<?xml version=\""1.0\"" encoding=\""UTF-8\""?>
<bpmn:definitions xmlns:bpmn=\""http://www.omg.org/spec/BPMN/20100524/MODEL\""
                  xmlns:bpmndi=\""http://www.omg.org/spec/BPMN/20100524/DI\""
                  xmlns:dc=\""http://www.omg.org/spec/DD/20100524/DC\""
                  id=\""Definitions_1\""
                  targetNamespace=\""http://bpmn.io/schema/bpmn\"">
  <bpmn:process id=\""Process_1\"" isExecutable=\""false\"">
    <bpmn:startEvent id=\""StartEvent_1\"" />
  </bpmn:process>
  <bpmndi:BPMNDiagram id=\""BPMNDiagram_1\"">
    <bpmndi:BPMNPlane id=\""BPMNPlane_1\"" bpmnElement=\""Process_1\"" />
  </bpmndi:BPMNDiagram>
</bpmn:definitions>`;
                    
                    modeler.importXML(xml).then(() => {
                        return 'Modeler initialized and diagram loaded successfully!';
                    }).catch(err => {
                        return 'Error loading diagram: ' + err.message;
                    });
                    
                    return 'Modeler created, loading diagram...';
                } catch (e) {
                    return 'Error: ' + e.message + '\\nStack: ' + e.stack;
                }
            ");
            
            _result = result;
            
            // Wait a bit and check again
            await Task.Delay(1000);
            _result += "\n\nChecking after 1 second...";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            _result = $"Error: {ex.Message}\n{ex.StackTrace}";
        }
    }
}
