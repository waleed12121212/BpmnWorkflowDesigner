@page "/dmn-editor"
@page "/dmn-editor/{DmnId:guid}"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.SignalR.Client
@using BpmnWorkflow.Client.Models
@using BpmnWorkflow.Client.Services
@using Blazored.LocalStorage
@attribute [Authorize]
@inject IDmnService DmnService
@inject IJSRuntime JsRuntime
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject NavigationManager NavigationManager
@inject ILocalStorageService LocalStorage
@inject ICommentService CommentService
@inject AuthenticationStateProvider AuthStateProvider
@inject Microsoft.Extensions.Configuration.IConfiguration Configuration
@implements IAsyncDisposable

<PageTitle>DMN Editor | @_dmnRequest.Name</PageTitle>

<RadzenStack Gap="1rem">
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
        <RadzenButton Icon="arrow_back" ButtonStyle="ButtonStyle.Light" Click="@GoBack" title="Back to list" />
        <RadzenText TextStyle="TextStyle.H3" Style="margin-bottom: 0;">
            @(DmnId.HasValue ? "Edit Decision" : "New Decision")
        </RadzenText>
        @if (DmnId.HasValue && _activeUsers.Any())
        {
            <RadzenBadge BadgeStyle="BadgeStyle.Success" IsPill="true" Text="@($"{_activeUsers.Count} Online: {string.Join(", ", _activeUsers)}")" Style="margin-left: 1rem;" />
        }
    </RadzenStack>

    <RadzenCard>
        <RadzenTextBox @bind-Value="_dmnRequest.Name" Placeholder="Decision name" Style="width:100%;" />
    </RadzenCard>

    <RadzenCard Style="height:750px; overflow:hidden; padding: 0;">
        <RadzenStack Orientation="Orientation.Horizontal" Gap="0" Style="height:100%;"> 
            <!-- Canvas Column -->
            <RadzenStack Gap="0" Style="flex: 1; height:100%; border-right: 1px solid #eee;">
                <!-- Toolbar -->
                <div style="padding: 0.5rem; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                    <RadzenButton Icon="undo" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Light" Click="@Undo" title="Undo" />
                    <RadzenButton Icon="redo" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Light" Click="@Redo" title="Redo" />

                    <div class="toolbar-divider"></div>

                    <RadzenButton Icon="zoom_in" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Light" Click="@ZoomIn" title="Zoom In" />
                    <RadzenButton Icon="zoom_out" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Light" Click="@ZoomOut" title="Zoom Out" />
                    <RadzenButton Icon="fit_screen" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Light" Click="@ZoomReset" title="Fit to Screen" />

                    <div class="toolbar-divider"></div>

                    <RadzenButton Icon="download" Text="XML" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Secondary" Click="@DownloadXml" />
                    <RadzenButton Icon="fullscreen" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Light" Click="@ToggleFullScreen" title="Fullscreen" />
                    
                    <div style="margin-left: auto;">
                        <RadzenButton Text="Save" Icon="save" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" Click="@SaveDmn" IsLoading="@_isSaving" />
                    </div>
                </div>

                <!-- Canvas -->
                <div style="flex: 1; position: relative; overflow: hidden; background: #fff;" id="dmn-editor-root">
                    <div id="dmn-canvas" style="width: 100%; height: 100%;"></div>
                    <div id="dmn-properties-panel" style="position: absolute; top: 0; right: 0; width: 300px; height: 100%; background: white; border-left: 1px solid #ccc; overflow: auto; display: none;"></div>
                </div>
            </RadzenStack>

            <!-- Properties/Right Panel -->
            <div style="width: 350px; height: 100%; background: #fdfdfd; display: flex; flex-direction: column;">
                <RadzenTabs Style="height: 100%; display: flex; flex-direction: column;">
                    <Tabs>
                        <RadzenTabsItem Text="Settings" Icon="settings">
                            <RadzenStack Gap="1rem" Style="padding: 1rem;">
                                <RadzenFormField Text="Description" Style="width: 100%;">
                                    <RadzenTextArea @bind-Value="_dmnRequest.Description" Rows="3" />
                                </RadzenFormField>
                                <RadzenAlert Severity="Severity.Info" AllowClose="false" Size="AlertSize.Small">
                                    Use the DMN editor to create decision tables and decision requirement diagrams.
                                </RadzenAlert>
                            </RadzenStack>
                        </RadzenTabsItem>

                        <RadzenTabsItem Text="History" Icon="history">
                            <div style="padding: 1rem; height: 600px; overflow-y: auto;">
                                @if (_isVersionsLoading)
                                {
                                    <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                                }
                                else
                                {
                                    <RadzenStack Gap="0.5rem">
                                        @foreach (var version in _versions)
                                        {
                                            <RadzenCard Style="padding: 0.75rem; cursor: pointer;" @onclick="() => RestoreVersion(version)">
                                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                                    <RadzenText TextStyle="TextStyle.Subtitle2" Style="margin:0;">v@version.VersionNumber</RadzenText>
                                                    <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@version.CreatedAt.ToLocalTime().ToString("MMM dd, HH:mm")" />
                                                </div>
                                                <RadzenText TextStyle="TextStyle.Caption" Style="margin-top:0.25rem;">@version.Comment</RadzenText>
                                            </RadzenCard>
                                        }
                                    </RadzenStack>
                                }
                            </div>
                        </RadzenTabsItem>
                    </Tabs>
                </RadzenTabs>
            </div>
        </RadzenStack>
    </RadzenCard>
</RadzenStack>

<style>
    .toolbar-divider {
        width: 1px;
        height: 24px;
        background: #eee;
        margin: 0 0.5rem;
    }

    .rz-tabview-panels {
        flex: 1;
        overflow: hidden;
    }
</style>

@code {
    [Parameter] public Guid? DmnId { get; set; }

    private UpsertDmnRequest _dmnRequest = new() { 
        Name = "Untitled Decision", 
        DmnXml = @"<?xml version=""1.0"" encoding=""UTF-8""?>
<definitions xmlns=""https://www.omg.org/spec/DMN/20191111/MODEL/"" xmlns:dmndi=""https://www.omg.org/spec/DMN/20191111/DMNDI/"" id=""Definitions_1"" name=""Definitions"" namespace=""http://camunda.org/schema/1.0/dmn"">
  <decision id=""Decision_1"" name=""Decision 1"">
    <decisionTable id=""DecisionTable_1"">
      <input id=""Input_1"">
        <inputExpression id=""InputExpression_1"" typeRef=""string"">
          <text></text>
        </inputExpression>
      </input>
      <output id=""Output_1"" typeRef=""string"" />
    </decisionTable>
  </decision>
</definitions>" 
    };
    private bool _isSaving;
    private bool _isInitialized;

    private IEnumerable<DmnVersionDto> _versions = new List<DmnVersionDto>();
    private bool _isVersionsLoading;

    private List<string> _activeUsers = new();
    private Guid? _currentUserId;
    private string _currentUserName = "Unknown";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            _currentUserId = Guid.Parse(user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? Guid.Empty.ToString());
            _currentUserName = user.Identity.Name ?? "User";
        }

        if (DmnId.HasValue)
        {
            var dmn = await DmnService.GetByIdAsync(DmnId.Value);
            if (dmn != null)
            {
                _dmnRequest.Name = dmn.Name;
                _dmnRequest.Description = dmn.Description;
                _dmnRequest.DmnXml = dmn.DmnXml;
            }
            
            await LoadVersions();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_isInitialized)
        {
            await Task.Delay(500);
            await JsRuntime.InvokeVoidAsync("DmnModeler.initialize", "dmn-canvas", _dmnRequest.DmnXml);
            _isInitialized = true;
        }
    }

    private async Task SaveDmn()
    {
        _isSaving = true;
        try
        {
            var xml = await JsRuntime.InvokeAsync<string>("DmnModeler.getXML");
            if (string.IsNullOrEmpty(xml))
            {
                NotificationService.Notify(NotificationSeverity.Warning, "Warning", "Failed to get DMN XML");
                return;
            }

            _dmnRequest.DmnXml = xml;

            if (DmnId.HasValue)
            {
                await DmnService.UpdateAsync(DmnId.Value, _dmnRequest, "Updated from editor");
                NotificationService.Notify(NotificationSeverity.Success, "Saved", "Decision saved successfully.");
            }
            else
            {
                var result = await DmnService.CreateAsync(_dmnRequest);
                if (result != null)
                {
                    NotificationService.Notify(NotificationSeverity.Success, "Created", "New decision created.");
                    NavigationManager.NavigateTo($"/dmn-editor/{result.Id}");
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task LoadVersions()
    {
        if (!DmnId.HasValue) return;
        _isVersionsLoading = true;
        _versions = await DmnService.GetVersionsAsync(DmnId.Value);
        _isVersionsLoading = false;
    }

    private async Task RestoreVersion(DmnVersionDto version)
    {
        var confirm = await DialogService.Confirm("Are you sure you want to restore this version? Unsaved changes will be lost.", "Restore Version");
        if (confirm == true)
        {
            await JsRuntime.InvokeVoidAsync("DmnModeler.importXML", version.DmnXml);
            _dmnRequest.DmnXml = version.DmnXml;
            NotificationService.Notify(NotificationSeverity.Info, "Restored", $"Version {version.VersionNumber} restored.");
        }
    }

    private async Task DownloadXml()
    {
        var xml = await JsRuntime.InvokeAsync<string>("DmnModeler.getXML");
        if (!string.IsNullOrEmpty(xml))
        {
            await JsRuntime.InvokeVoidAsync("DmnModeler.downloadXML", $"{_dmnRequest.Name.Replace(" ", "_")}.dmn", xml);
        }
    }

    private async Task Undo() => await JsRuntime.InvokeVoidAsync("DmnModeler.undo");
    private async Task Redo() => await JsRuntime.InvokeVoidAsync("DmnModeler.redo");
    private async Task ZoomIn() => await JsRuntime.InvokeVoidAsync("DmnModeler.zoomIn");
    private async Task ZoomOut() => await JsRuntime.InvokeVoidAsync("DmnModeler.zoomOut");
    private async Task ZoomReset() => await JsRuntime.InvokeVoidAsync("DmnModeler.zoomReset");
    
    private async Task ToggleFullScreen()
    {
        await JsRuntime.InvokeVoidAsync("DmnModeler.toggleFullScreen", "dmn-editor-root");
    }

    private void GoBack() => NavigationManager.NavigateTo("/dmn-decisions");

    public async ValueTask DisposeAsync()
    {
        try { await JsRuntime.InvokeVoidAsync("DmnModeler.destroy"); } catch { }
    }
}
