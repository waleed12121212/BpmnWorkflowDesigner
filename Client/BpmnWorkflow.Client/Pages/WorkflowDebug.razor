@page "/workflow-debug/{WorkflowId:guid}"
@inject Services.IWorkflowService WorkflowService
@inject Radzen.NotificationService NotificationService

<PageTitle>Workflow Debug</PageTitle>

<RadzenStack Gap="1rem">
    <RadzenText TextStyle="TextStyle.H3">Workflow Debug View</RadzenText>
    
    @if (_workflow != null)
    {
        <RadzenCard>
            <RadzenStack Gap="0.5rem">
                <RadzenText TextStyle="TextStyle.H5">Workflow Details</RadzenText>
                <RadzenText><strong>ID:</strong> @_workflow.Id</RadzenText>
                <RadzenText><strong>Name:</strong> @_workflow.Name</RadzenText>
                <RadzenText><strong>Description:</strong> @_workflow.Description</RadzenText>
                <RadzenText><strong>Created:</strong> @_workflow.CreatedAt</RadzenText>
                <RadzenText><strong>Updated:</strong> @_workflow.UpdatedAt</RadzenText>
            </RadzenStack>
        </RadzenCard>
        
        <RadzenCard>
            <RadzenStack Gap="0.5rem">
                <RadzenText TextStyle="TextStyle.H5">BPMN XML</RadzenText>
                @if (!string.IsNullOrEmpty(_workflow.BpmnXml))
                {
                    <RadzenText Style="font-family: monospace; white-space: pre-wrap; background: #f5f5f5; padding: 1rem; border-radius: 4px; font-size: 12px; max-height: 400px; overflow-y: auto;">@_workflow.BpmnXml</RadzenText>
                    <RadzenText><strong>XML Length:</strong> @_workflow.BpmnXml.Length characters</RadzenText>
                }
                else
                {
                    <RadzenText Style="color: red;">No BPMN XML found!</RadzenText>
                }
            </RadzenStack>
        </RadzenCard>
        
        @if (!string.IsNullOrEmpty(_workflow.SvgPreview))
        {
            <RadzenCard>
                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.H5">SVG Preview</RadzenText>
                    <div style="border: 1px solid #ddd; padding: 1rem; background: white;">
                        @((MarkupString)_workflow.SvgPreview)
                    </div>
                    <RadzenText><strong>SVG Length:</strong> @_workflow.SvgPreview.Length characters</RadzenText>
                </RadzenStack>
            </RadzenCard>
        }
        else
        {
            <RadzenCard>
                <RadzenText Style="color: orange;">No SVG preview available</RadzenText>
            </RadzenCard>
        }
    }
    else if (_loading)
    {
        <RadzenText>Loading...</RadzenText>
    }
    else
    {
        <RadzenText Style="color: red;">Workflow not found!</RadzenText>
    }
</RadzenStack>

@code {
    [Parameter] public Guid WorkflowId { get; set; }
    
    private BpmnWorkflow.Client.Models.WorkflowDto? _workflow;
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Console.WriteLine($"Loading workflow debug view for ID: {WorkflowId}");
            _workflow = await WorkflowService.GetByIdAsync(WorkflowId);
            
            if (_workflow != null)
            {
                Console.WriteLine($"Workflow loaded: {_workflow.Name}");
                Console.WriteLine($"BPMN XML length: {_workflow.BpmnXml?.Length ?? 0}");
                Console.WriteLine($"SVG Preview length: {_workflow.SvgPreview?.Length ?? 0}");
            }
            else
            {
                Console.WriteLine("Workflow not found");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading workflow: {ex.Message}");
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load workflow: {ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }
}
