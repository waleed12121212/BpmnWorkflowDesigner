@page "/dmn-decisions"
@using Microsoft.AspNetCore.Authorization
@using BpmnWorkflow.Client.Models
@using BpmnWorkflow.Client.Services
@attribute [Authorize]
@inject IDmnService DmnService
@inject NavigationManager NavigationManager
@inject DialogService DialogService
@inject NotificationService NotificationService

<PageTitle>Decision Tables | DMN</PageTitle>

<RadzenStack Gap="1.5rem">
    <RadzenRow AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
        <RadzenColumn Size="12" SizeMD="6">
            <RadzenText TextStyle="TextStyle.H3" Style="margin:0;">Decision Tables (DMN)</RadzenText>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="6" Style="text-align: right;">
            <RadzenButton Icon="add" Text="New Decision" ButtonStyle="ButtonStyle.Primary" Click="@CreateNewDmn" />
        </RadzenColumn>
    </RadzenRow>

    <RadzenCard>
        <RadzenStack Gap="1rem">
            <RadzenTextBox @bind-Value="@_searchTerm" Placeholder="Search decisions..." Style="width: 100%;" 
                          @oninput="@(args => OnSearchChanged(args.Value?.ToString()))" />

            @if (_isLoading)
            {
                <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
            }
            else if (!_dmns.Any())
            {
                <RadzenAlert Severity="Severity.Info" AllowClose="false">
                    No decision tables found. Create your first DMN decision!
                </RadzenAlert>
            }
            else
            {
                <RadzenDataGrid Data="@_dmns" TItem="DmnDefinitionDto" AllowSorting="true" AllowFiltering="false" 
                               AllowPaging="true" PageSize="10" Style="height: 600px;">
                    <Columns>
                        <RadzenDataGridColumn TItem="DmnDefinitionDto" Property="Name" Title="Name" Width="250px">
                            <Template Context="dmn">
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                    <RadzenIcon Icon="account_tree" Style="color: var(--rz-primary);" />
                                    <RadzenLink Path="@($"/dmn-editor/{dmn.Id}")" Text="@dmn.Name" Style="font-weight: 500;" />
                                </RadzenStack>
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="DmnDefinitionDto" Property="Description" Title="Description" Width="300px">
                            <Template Context="dmn">
                                <RadzenText TextStyle="TextStyle.Body2" Style="color: #888;">
                                    @(string.IsNullOrEmpty(dmn.Description) ? "No description" : dmn.Description)
                                </RadzenText>
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="DmnDefinitionDto" Property="OwnerName" Title="Owner" Width="180px" />

                        <RadzenDataGridColumn TItem="DmnDefinitionDto" Property="UpdatedAt" Title="Last Modified" Width="180px">
                            <Template Context="dmn">
                                @dmn.UpdatedAt.ToLocalTime().ToString("MMM dd, yyyy HH:mm")
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="DmnDefinitionDto" Title="Actions" Width="150px" Sortable="false">
                            <Template Context="dmn">
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                                    <RadzenButton Icon="edit" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Light" 
                                                Click="@(() => EditDmn(dmn.Id))" title="Edit" />
                                    <RadzenButton Icon="delete" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Danger" 
                                                Click="@(() => DeleteDmn(dmn))" title="Delete" />
                                </RadzenStack>
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            }
        </RadzenStack>
    </RadzenCard>
</RadzenStack>

@code {
    private IEnumerable<DmnDefinitionDto> _dmns = new List<DmnDefinitionDto>();
    private string _searchTerm = string.Empty;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadDmns();
    }

    private async Task LoadDmns()
    {
        _isLoading = true;
        try
        {
            _dmns = await DmnService.GetAllAsync(_searchTerm);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OnSearchChanged(string? value)
    {
        _searchTerm = value ?? string.Empty;
        await LoadDmns();
    }

    private void CreateNewDmn()
    {
        NavigationManager.NavigateTo("/dmn-editor");
    }

    private void EditDmn(Guid id)
    {
        NavigationManager.NavigateTo($"/dmn-editor/{id}");
    }

    private async Task DeleteDmn(DmnDefinitionDto dmn)
    {
        var confirm = await DialogService.Confirm($"Are you sure you want to delete '{dmn.Name}'?", "Delete Decision", 
            new ConfirmOptions { OkButtonText = "Delete", CancelButtonText = "Cancel" });

        if (confirm == true)
        {
            var result = await DmnService.DeleteAsync(dmn.Id);
            if (result)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Deleted", $"Decision '{dmn.Name}' deleted successfully.");
                await LoadDmns();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to delete decision.");
            }
        }
    }
}
